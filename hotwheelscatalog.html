const html = `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"><title>Hot Wheels — Export</title><style>body\{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:16px\} .grid\{display:grid;grid-template-columns:repeat\(auto-fill,minmax\(220px,1fr\)\);gap:12px\} .card\{border:1px solid #ddd;border-radius:12px;overflow:hidden\} .card img\{width:100%;height:140px;object-fit:cover;background:#f3f4f6\} .pad\{padding:10px\} .meta\{font-size:12px;color:#555\} .title\{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis\}</style></head><body><h2>Hot Wheels Collection \(Export\)</h2><div id=\"count\"></div><div class=\"grid\" id=\"grid\"></div><script>const data=\$\{data\}; const grid=document.getElementById\('grid'\); const count=document.getElementById\('count'\); count.textContent = data.length + ' items'; data.forEach\(x=>\{ const d=document.createElement\('div'\); d.className='card'; d.innerHTML = '<img src=\\"'\+\(x.front||''\)\+\\"\\/><div class=\\'pad\\'><div class=\\'title\\>'\+\(x.name||'Untitled'\)\+'</div><div class=\\'meta\\>'\+\[x.code,x.series,x.seriesNo,x.catalog\].filter\(Boolean\).join\(' • '\)\+'<\\/div><div class=\\'meta\\>'\+\[x.make,x.modelYear,x.color,x.releaseYear,x.condition\].filter\(Boolean\).join\(' • '\)\+'<\\/div><\\/div>'; grid.appendChild\(d\); \}\);<\\/script><\\/body><\\/html>`;<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hot Wheels Collector</title>
  <!-- iOS PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="HW Collector" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Crect rx='56' width='256' height='256' fill='%232563eb'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' dominant-baseline='middle' font-family='Arial' font-weight='700' font-size='120' fill='white'%3EHW%3C/text%3E%3C/svg%3E" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- localForage for IndexedDB storage -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <!-- PapaParse for CSV import -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- QR Code generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    .tap{-webkit-tap-highlight-color:transparent}
    .glass{background:rgba(255,255,255,.7);backdrop-filter:blur(6px)}
    .print\:hidden{ }
    @media print{ .no-print{ display:none !important } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <header class="sticky top-0 z-20 glass border-b">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="h-9 w-9 rounded-xl bg-blue-600 text-white flex items-center justify-center font-bold">HW</div>
      <h1 class="text-lg font-semibold">Hot Wheels Collector</h1>
      <div id="count" class="ml-auto text-xs text-gray-600">0 saved</div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-4 space-y-6">
    <!-- Add Form -->
    <section class="p-4 bg-white rounded-2xl border shadow-sm">
      <h2 class="font-semibold">1) Add a car</h2>
      <p class="text-sm text-gray-600 mt-1">Fill details, take <b>Front</b> and <b>Back</b> photos, then Save.</p>

      <div class="grid grid-cols-2 gap-3 mt-3">
        <label class="group flex flex-col items-center justify-center aspect-[4/3] border-2 border-dashed rounded-xl text-sm text-gray-500 hover:bg-gray-50 cursor-pointer tap">
          <input id="imgFront" type="file" accept="image/*" capture="environment" class="hidden" />
          <img id="prevFront" class="hidden object-contain h-full w-full p-2" alt="Front preview" />
          <span id="frontLabel">＋ Front Image</span>
        </label>
        <label class="group flex flex-col items-center justify-center aspect-[4/3] border-2 border-dashed rounded-xl text-sm text-gray-500 hover:bg-gray-50 cursor-pointer tap">
          <input id="imgBack" type="file" accept="image/*" capture="environment" class="hidden" />
          <img id="prevBack" class="hidden object-contain h-full w-full p-2" alt="Back preview" />
          <span id="backLabel">＋ Back Image</span>
        </label>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="text-xs text-gray-600">Code</label>
          <input id="fCode" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., HCT29" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Name</label>
          <input id="fName" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., Nissan Skyline GT-R (BNR34)" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Color</label>
          <input id="fColor" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="Blue / Silver" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Series (text)</label>
          <input id="fSeries" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="Mainline / Car Culture / Premium" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Series No</label>
          <input id="fSeriesNo" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., 2/5" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Catalog No (x/y)</label>
          <input id="fCatalog" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., 175/250" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Release Year</label>
          <input id="fReleaseYear" type="number" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., 2024" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Condition</label>
          <select id="fCondition" class="w-full mt-1 px-3 py-2 border rounded-xl">
            <option value="">Select…</option>
            <option>Carded</option>
            <option>Loose – Mint</option>
            <option>Loose – Played</option>
            <option>Sealed Case</option>
            <option>Damaged Card</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Make</label>
          <input id="fMake" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., Nissan / Chevrolet" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Model Year</label>
          <input id="fModelYear" type="number" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="e.g., 1999" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Notes</label>
          <input id="fNotes" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="Optional" />
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-3">
        <button id="saveBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Save item</button>
        <button id="clearBtn" class="px-4 py-2 rounded-xl border">Clear form</button>
        <span id="saveMsg" class="text-sm text-red-600"></span>
      </div>
    </section>

    <!-- List & Controls -->
    <section class="p-4 bg-white rounded-2xl border shadow-sm">
      <div class="flex flex-wrap items-center gap-2">
        <h2 class="font-semibold">2) Collection</h2>
        <input id="search" class="ml-auto px-3 py-2 border rounded-xl text-sm" placeholder="Search name/code/series…" />
        <label class="text-sm text-gray-700">Sort:</label>
        <select id="sortSel" class="px-2 py-2 border rounded-xl text-sm">
          <option value="addedDesc">Recently Added</option>
          <option value="nameAsc">Name A→Z</option>
          <option value="nameDesc">Name Z→A</option>
          <option value="yearAsc">Release Year ↑</option>
          <option value="yearDesc">Release Year ↓</option>
        </select>
        <label class="px-3 py-2 border rounded-xl cursor-pointer text-sm">Import CSV<input id="importCsv" type="file" accept=".csv" hidden></label>
        <button id="expCSV" class="px-3 py-2 rounded-xl border">Export CSV</button>
        <button id="expJSON" class="px-3 py-2 rounded-xl border">Export JSON</button>
        <button id="expHTML" class="px-3 py-2 rounded-xl border">Export Single HTML</button>
        <button id="qrBtn" class="px-3 py-2 rounded-xl border">QR Labels (selected)</button>
      </div>

      <div id="grid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>

      <div class="mt-4 flex items-center justify-center gap-2">
        <button id="prevPage" class="px-3 py-1.5 border rounded-xl">Prev</button>
        <span id="pageInfo" class="text-sm text-gray-700">Page 1 / 1</span>
        <button id="nextPage" class="px-3 py-1.5 border rounded-xl">Next</button>
      </div>
    </section>
  </main>

  <template id="cardTpl">
    <div class="border rounded-2xl overflow-hidden bg-white" data-id="">
      <div class="grid grid-cols-2 gap-0 bg-gray-50">
        <img class="h-28 w-full object-cover" />
        <img class="h-28 w-full object-cover" />
      </div>
      <div class="p-3 space-y-1">
        <div class="flex items-center gap-2">
          <input type="checkbox" class="sel h-4 w-4" />
          <div class="font-medium truncate name"></div>
        </div>
        <div class="text-xs text-gray-600 truncate meta"></div>
        <div class="text-[11px] text-gray-500 truncate meta2"></div>
        <div class="flex flex-wrap gap-2 pt-2">
          <button class="px-2 py-1 text-xs rounded-lg border share">Share link</button>
          <button class="px-2 py-1 text-xs rounded-lg border edit">Edit</button>
          <button class="px-2 py-1 text-xs rounded-lg border text-red-600 del">Delete</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Manifest + Service Worker (PWA single-file trick) -->
  <script>
    const manifest = {
      name: 'Hot Wheels Collector',
      short_name: 'HW Collector',
      start_url: '.',
      display: 'standalone',
      background_color: '#ffffff',
      theme_color: '#2563eb',
      icons: [
        { src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGUlEQVQoU2NkQAN/MwMDEyqGJgYGBgYGAB4vAQk2WoDsAAAAAElFTkSuQmCC', sizes: '192x192', type: 'image/png' }
      ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=manifestURL; document.head.appendChild(link);

    // Minimal offline cache
    const swCode = `self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('hwc-v2').then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const cp=res.clone();caches.open('hwc-v2').then(c=>c.put(e.request,cp));return res;})).catch(()=>caches.match('./')))});`;
    const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(swURL).catch(()=>{});
  </script>

  <script>
    // DOM refs
    const imgFront = document.getElementById('imgFront');
    const imgBack = document.getElementById('imgBack');
    const prevFront = document.getElementById('prevFront');
    const prevBack = document.getElementById('prevBack');
    const frontLabel = document.getElementById('frontLabel');
    const backLabel = document.getElementById('backLabel');

    const fCode = document.getElementById('fCode');
    const fName = document.getElementById('fName');
    const fColor = document.getElementById('fColor');
    const fSeries = document.getElementById('fSeries');
    const fSeriesNo = document.getElementById('fSeriesNo');
    const fCatalog = document.getElementById('fCatalog');
    const fReleaseYear = document.getElementById('fReleaseYear');
    const fCondition = document.getElementById('fCondition');
    const fMake = document.getElementById('fMake');
    const fModelYear = document.getElementById('fModelYear');
    const fNotes = document.getElementById('fNotes');

    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const grid = document.getElementById('grid');
    const cardTpl = document.getElementById('cardTpl');
    const search = document.getElementById('search');
    const count = document.getElementById('count');
    const pageInfo = document.getElementById('pageInfo');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const sortSel = document.getElementById('sortSel');
    const importCsv = document.getElementById('importCsv');
    const qrBtn = document.getElementById('qrBtn');

    localforage.config({ name: 'hotwheels', storeName: 'items' });

    const PAGE_SIZE = 10;
    let all = []; // full list
    let filtered = []; // after search
    let page = 1;

    function preview(input, imgEl, labelEl){
      const f = input.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      imgEl.src = url; imgEl.classList.remove('hidden'); labelEl.classList.add('hidden');
    }
    imgFront.addEventListener('change', ()=>preview(imgFront, prevFront, frontLabel));
    imgBack.addEventListener('change', ()=>preview(imgBack, prevBack, backLabel));

    async function fileToDataURL(file){
      return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });
    }

    // Resize images to keep storage small (long edge ~1280px)
    async function resizeImage(file, max=1280){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = ()=>{
          let {width:w, height:h} = img;
          const ratio = Math.max(w,h) / max;
          if (ratio > 1){ w = Math.round(w/ratio); h = Math.round(h/ratio); }
          const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
          const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          canvas.toBlob(b=>{ URL.revokeObjectURL(url); resolve(b ? URL.createObjectURL(b) : canvas.toDataURL('image/jpeg',0.85)); }, 'image/jpeg', 0.85);
        };
        img.onerror = e=>{ URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    async function blobUrlToDataUrl(blobUrl){
      const res = await fetch(blobUrl); const blob = await res.blob();
      return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); });
    });
    }

    function clearForm(){
      [fCode,fName,fColor,fSeries,fSeriesNo,fCatalog,fReleaseYear,fCondition,fMake,fModelYear,fNotes].forEach(el=>el.value='');
      [imgFront,imgBack].forEach(i=>i.value='');
      [prevFront,prevBack].forEach(img=>{ img.src=''; img.classList.add('hidden'); });
      [frontLabel,backLabel].forEach(l=>l.classList.remove('hidden'));
    }

    function uid(it){ return `${it.code||''}::${it.name||''}::${it.catalog||''}::${it.ts}`; }

    async function load(){ all = (await localforage.getItem('items')) || []; applySearch(); highlightFromHash(); }
    async function saveAll(){ await localforage.setItem('items', all); applySearch(); }

    saveBtn.addEventListener('click', async ()=>{
      const err = (m)=>{ document.getElementById('saveMsg').textContent=m; setTimeout(()=>document.getElementById('saveMsg').textContent='',3000); };
      try{
        const item = {
          code: fCode.value.trim(),
          name: fName.value.trim() || fCode.value.trim() || `Untitled ${new Date().toLocaleString()}`,
          color: fColor.value.trim(),
          series: fSeries.value.trim(),
          seriesNo: fSeriesNo.value.trim(),
          catalog: fCatalog.value.trim(), // x/y
          releaseYear: fReleaseYear.value ? parseInt(fReleaseYear.value,10) : null,
          condition: fCondition.value,
          make: fMake.value.trim(),
          modelYear: fModelYear.value ? parseInt(fModelYear.value,10) : null,
          notes: fNotes.value.trim(),
          ts: Date.now(),
          front: null,
          back: null
        };
        if (imgFront.files?.[0]){
          const resizedUrl = await resizeImage(imgFront.files[0]);
          item.front = await blobUrlToDataUrl(resizedUrl);
        }
        if (imgBack.files?.[0]){
          const resizedUrl2 = await resizeImage(imgBack.files[0]);
          item.back = await blobUrlToDataUrl(resizedUrl2);
        }
        all.unshift(item);
        await saveAll();
        clearForm();
        err('Saved ✔');
      }catch(e){ console.error(e); err('Save failed: '+ e.message); }
    }); return; }
      all.unshift(item);
      await saveAll();
      clearForm();
    });

    clearBtn.addEventListener('click', clearForm);

    function sortItems(arr){
      switch (sortSel.value){
        case 'nameAsc': return arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        case 'nameDesc': return arr.sort((a,b)=> (b.name||'').localeCompare(a.name||''));
        case 'yearAsc': return arr.sort((a,b)=> (a.releaseYear||0)-(b.releaseYear||0));
        case 'yearDesc': return arr.sort((a,b)=> (b.releaseYear||0)-(a.releaseYear||0));
        default: return arr.sort((a,b)=> (b.ts||0)-(a.ts||0)); // addedDesc
      }
    }

    function render(){
      // pagination
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (page > pages) page = pages;
      const start = (page-1)*PAGE_SIZE;
      const slice = filtered.slice(start, start + PAGE_SIZE);

      grid.innerHTML = '';
      slice.forEach((it, idx)=> grid.appendChild(renderCard(it, start+idx)) );

      pageInfo.textContent = `Page ${page} / ${pages}`;
      count.textContent = `${total} saved`;

      prevPageBtn.disabled = page<=1; nextPageBtn.disabled = page>=pages;
    }

    function renderCard(it, absIndex){
      const node = cardTpl.content.firstElementChild.cloneNode(true);
      const id = uid(it);
      node.dataset.id = id;
      node.id = 'item-' + btoa(id).replace(/[^a-z0-9]/gi,'');
      const imgs = node.querySelectorAll('img');
      imgs[0].src = it.front || '';
      imgs[1].src = it.back || '';

      node.querySelector('.name').textContent = it.name || '(untitled)';
      node.querySelector('.meta').textContent = [it.code, it.series, it.seriesNo, it.catalog].filter(Boolean).join(' • ');
      node.querySelector('.meta2').textContent = [it.make, it.modelYear, it.color, it.releaseYear, it.condition].filter(Boolean).join(' • ');

      node.querySelector('.share').addEventListener('click', ()=>{
        const url = `${location.origin}${location.pathname}#id=${encodeURIComponent(id)}`;
        if (navigator.share) navigator.share({ title: it.name, url }).catch(()=>copy(url));
        else copy(url);
      });

      node.querySelector('.edit').addEventListener('click', async ()=>{
        // load into form
        fCode.value = it.code||''; fName.value=it.name||''; fColor.value=it.color||''; fSeries.value=it.series||''; fSeriesNo.value=it.seriesNo||''; fCatalog.value=it.catalog||''; fReleaseYear.value=it.releaseYear||''; fCondition.value=it.condition||''; fMake.value=it.make||''; fModelYear.value=it.modelYear||''; fNotes.value=it.notes||'';
        if (it.front){ prevFront.src=it.front; prevFront.classList.remove('hidden'); frontLabel.classList.add('hidden'); }
        if (it.back){ prevBack.src=it.back; prevBack.classList.remove('hidden'); backLabel.classList.add('hidden'); }
        // remove from list so saving re-adds as new
        all.splice(absIndex,1);
        await saveAll();
        window.scrollTo({top:0,behavior:'smooth'});
      });

      node.querySelector('.del').addEventListener('click', async ()=>{
        if (!confirm('Delete this item?')) return;
        all.splice(absIndex,1);
        await saveAll();
      });

      return node;
    }

    function applySearch(){
      const q = (search.value||'').trim().toLowerCase();
      if (!q) filtered = [...all];
      else filtered = all.filter(it => (
        (it.name||'').toLowerCase().includes(q) ||
        (it.code||'').toLowerCase().includes(q) ||
        (it.series||'').toLowerCase().includes(q) ||
        (it.catalog||'').toLowerCase().includes(q) ||
        (it.color||'').toLowerCase().includes(q) ||
        (it.make||'').toLowerCase().includes(q)
      ));
      filtered = sortItems(filtered);
      page = 1; render();
    }

    search.addEventListener('input', ()=>applySearch());
    sortSel.addEventListener('change', ()=>applySearch());

    prevPageBtn.addEventListener('click', ()=>{ if (page>1){ page--; render(); }});
    nextPageBtn.addEventListener('click', ()=>{ page++; render(); });

    // Copy helper
    async function copy(t){ try{ await navigator.clipboard.writeText(t); alert('Link copied'); }catch{ prompt('Copy link:', t); } }

    // Import CSV
    importCsv.addEventListener('change', e=>{
      const file = e.target.files?.[0]; if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async (res) => {
          const rows = res.data;
          for (const r of rows){
            const it = {
              code: r.Code || r.code || '',
              name: r.Name || r.name || '',
              front: r.FrontImage || r.front || '', // URL or dataURI
              back: r.BackImage || r.back || '',
              color: r.Color || r.color || '',
              series: r.Series || r.series || '',
              seriesNo: r.SeriesNo || r.seriesNo || r['Series No'] || '',
              catalog: r.CatalogNo || r.catalogNo || r['Catalog No (x/y)'] || r['CatalogNo'] || '',
              releaseYear: parseInt(r.ReleaseYear || r.releaseYear || r.Year || '', 10) || null,
              condition: r.Condition || r.condition || '',
              make: r.Make || r.make || '',
              modelYear: parseInt(r.ModelYear || r.modelYear || '', 10) || null,
              notes: r.Notes || r.notes || '',
              ts: Date.now()
            };
            if (it.name) all.push(it);
          }
          await saveAll();
          importCsv.value = '';
        }
      });
    });

    // QR Labels for selected
    qrBtn.addEventListener('click', ()=>{
      const selected = Array.from(document.querySelectorAll('#grid .sel:checked')).map(cb=> cb.closest('[data-id]')?.dataset.id ).filter(Boolean);
      if (!selected.length){ alert('Select at least one item.'); return; }
      const items = selected.map(id=> all.find(it => uid(it)===id)).filter(Boolean);
      openQrWindow(items);
    });

    function openQrWindow(items){
      const w = window.open('', '_blank');
      const css = `body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;padding:16px} .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px} .card{border:1px solid #ddd;border-radius:12px;padding:10px;break-inside:avoid} .name{font-size:12px;margin-top:6px}`;
      const htmlHead = `<head><title>QR Labels</title><style>${css}</style></head>`;
      const base = `${location.origin}${location.pathname}`;
      const cards = items.map(it=>{
        const id = encodeURIComponent(uid(it));
        const url = `${base}#id=${id}`;
        return `<div class="card"><canvas data-url="${url}"></canvas><div class="name">${escapeHtml(it.name||'')}</div></div>`;
      }).join('');
      w.document.write(`<html>${htmlHead}<body><h3>QR Labels</h3><div class="grid">${cards}</div><script>${escapeScriptForInline(qrCanvasScript())}<\/script></body></html>`);
      w.document.close();
    }

    function qrCanvasScript(){
      return `(()=>{function gen(){document.querySelectorAll('canvas[data-url]').forEach(c=>{const url=c.getAttribute('data-url'); window.QRCode.toCanvas(c, url, {width:160, margin:1});});} if(!window.QRCode){var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js'; s.onload=gen; document.head.appendChild(s);} else {gen();}})();`;
    }

    function escapeScriptForInline(s){ return s.replace(/<\//g,'<\/'); }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }

    // Hash deep-link support
    window.addEventListener('hashchange', highlightFromHash);
    function highlightFromHash(){
      const m = location.hash.match(/#id=(.+)$/); if (!m) return;
      const id = decodeURIComponent(m[1]);
      const idx = all.findIndex(it=> uid(it)===id);
      if (idx === -1) return;
      // compute page and render
      const newPage = Math.floor(idx / 10) + 1; if (newPage !== page){ page = newPage; render(); }
      const cardId = 'item-' + btoa(id).replace(/[^a-z0-9]/gi,'');
      const el = document.getElementById(cardId); if (el){ el.style.outline='2px solid #2563eb'; el.style.borderRadius = '12px'; el.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(()=>{el.style.outline=''},2000); }
    }

    function applySearchAndKeepSort(){ filtered = sortItems(filtered); render(); }

    // Export
    document.getElementById('expJSON').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
      download(blob,'hotwheels.json');
    });
    document.getElementById('expCSV').addEventListener('click', ()=>{
      const header = ['Code','Name','FrontImage','BackImage','Color','Series','SeriesNo','CatalogNo','ReleaseYear','Condition','Make','ModelYear','Notes'];
      const rows = [header.join(',')].concat(all.map(x=>[
        csv(x.code), csv(x.name), csv(x.front), csv(x.back), csv(x.color), csv(x.series), csv(x.seriesNo), csv(x.catalog), x.releaseYear||'', csv(x.condition), csv(x.make), x.modelYear||'', csv(x.notes)
      ].join(',')));
      const blob = new Blob([rows.join('
')],{type:'text/csv'});
      download(blob,'hotwheels.csv');
    });
    document.getElementById('expHTML').addEventListener('click', ()=>{
      const data = JSON.stringify(all);
      const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Hot Wheels — Export</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:16px} .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px} .card{border:1px solid #ddd;border-radius:12px;overflow:hidden} .card img{width:100%;height:140px;object-fit:cover;background:#f3f4f6} .pad{padding:10px} .meta{font-size:12px;color:#555} .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}</style></head><body><h2>Hot Wheels Collection (Export)</h2><div id="count"></div><div class="grid" id="grid"></div><script>const data=${data}; const grid=document.getElementById('grid'); const count=document.getElementById('count'); count.textContent = data.length + ' items'; data.forEach(x=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML = '<img src="'+(x.front||'')+'"/><div class=\'pad\'><div class=\'title\'>'+(x.name||'Untitled')+'</div><div class=\'meta\'>'+[x.code,x.series,x.seriesNo,x.catalog].filter(Boolean).join(' • ')+'</div><div class=\'meta\'>'+[x.make,x.modelYear,x.color,x.releaseYear,x.condition].filter(Boolean).join(' • ')+'</div></div>'; grid.appendChild(d); });</script></body></html>`;
      const blob = new Blob([html],{type:'text/html'});
      download(blob,'hotwheels_export.html');
    });
    function csv(v){ if(v==null) return ''; const s=String(v).replaceAll('"','""'); return /[,
]/.test(s)?`"${s}"`:s; }
    function download(blob, name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }
    function csv(v){ if(v==null) return ''; const s=String(v).replaceAll('"','""'); return /[,
]/.test(s)?`"${s}"`:s; }
    function download(blob, name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }

    // Init
    (async ()=>{ await load(); })();
  </script>
</body>
</html>
